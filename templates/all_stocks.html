{% extends "base.html" %}

{% block title %}qweretjr Markets - All Stocks{% endblock %}

{% block content %}
<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <div>
    <h2 style="margin: 0;">ALL STOCKS</h2>
    <small style="color: #8ba0b8;" id="totalCount">Top 500 companies</small>
  </div>
  <div style="background: #1a2535; padding: 8px 15px; border-radius: 20px;">
    <span id="displayCount" style="color: #00f5a0; font-weight: bold;">500</span>
    <span style="color: #8ba0b8;">shown</span>
  </div>
</div>

<!-- Market Status Bar -->
<div style="background: #0f1622; border: 1px solid #1a2535; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
  <div>
    <span style="color: #8ba0b8;">Market Status:</span>
    <span id="marketStatus" style="margin-left: 10px; padding: 4px 10px; border-radius: 4px; font-weight: bold;"></span>
  </div>
  <div>
    <span style="color: #8ba0b8;">Last Updated:</span>
    <span id="marketTime" style="margin-left: 10px; font-family: monospace;"></span>
  </div>
</div>

<!-- Search and Filter -->
<div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
  <input 
    type="text" 
    id="searchBox" 
    placeholder="Search symbol or company..." 
    style="flex: 1; padding: 10px; background: #0f1622; border: 1px solid #1a2535; border-radius: 5px; color: white; min-width: 200px;"
  >
  
  <select id="filterSelect" style="padding: 10px; background: #0f1622; border: 1px solid #1a2535; border-radius: 5px; color: white; min-width: 120px;">
    <option value="all">All Signals</option>
    <option value="BUY">BUY</option>
    <option value="HOLD">HOLD</option>
    <option value="SELL">SELL</option>
  </select>
</div>

<!-- Loading -->
<div id="loadingState" style="text-align: center; padding: 50px;">
  <div style="border: 3px solid #1a2535; border-top-color: #00f5a0; width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite;"></div>
  <p>Loading 500 stocks...</p>
</div>

<!-- Error -->
<div id="errorState" style="text-align: center; padding: 50px; color: #ff3d71; display: none;">
  Failed to load data
</div>

<!-- Table -->
<div id="tableView" style="display: none; overflow-x: auto;">
  <table style="width: 100%; border-collapse: collapse; background: #0f1622; border-radius: 8px; overflow: hidden;">
    <thead style="background: #1a2535;">
      <tr>
        <th style="padding: 12px; text-align: left;">#</th>
        <th style="padding: 12px; text-align: left;">Symbol</th>
        <th style="padding: 12px; text-align: left;">Price</th>
        <th style="padding: 12px; text-align: left;">Day %</th>
        <th style="padding: 12px; text-align: left;">RSI</th>
        <th style="padding: 12px; text-align: left;">Trend</th>
        <th style="padding: 12px; text-align: left;">Score</th>
        <th style="padding: 12px; text-align: left;">Signal</th>
        <th style="padding: 12px; text-align: left;">Status</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Pagination -->
<div id="pagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 30px; flex-wrap: wrap;"></div>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .table-row {
    border-bottom: 1px solid #1a2535;
    cursor: pointer;
  }
  .table-row:hover {
    background: rgba(0,245,160,0.05);
  }
  .table-row td {
    padding: 12px;
  }
  .positive { color: #00f5a0; }
  .negative { color: #ff3d71; }
  .page-btn {
    padding: 8px 12px;
    background: #1a2535;
    border: 1px solid #2a3747;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    min-width: 40px;
  }
  .page-btn.active {
    background: #00f5a0;
    color: #0c1018;
    border-color: #00f5a0;
  }
  .page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .signal-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  .signal-buy { background: rgba(0,245,160,0.2); color: #00f5a0; }
  .signal-hold { background: rgba(255,170,0,0.2); color: #ffaa00; }
  .signal-sell { background: rgba(255,61,113,0.2); color: #ff3d71; }
  .status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  .status-open { background: rgba(0,245,160,0.2); color: #00f5a0; }
  .status-closed { background: rgba(255,61,113,0.2); color: #ff3d71; }
</style>

<script>
let allStocks = [];
let filteredStocks = [];
let currentPage = 1;
const pageSize = 50;

function isMarketOpen() {
  const now = new Date();
  const day = now.getDay();
  const hours = now.getHours();
  const minutes = now.getMinutes();
  const timeInMinutes = hours * 60 + minutes;
  
  // Market is open: Mon-Fri, 9:30 AM - 4:00 PM ET
  if (day >= 1 && day <= 5) {
    if (timeInMinutes >= 570 && timeInMinutes <= 960) {
      return true;
    }
  }
  return false;
}

function updateMarketStatus() {
  const marketOpen = isMarketOpen();
  const statusEl = document.getElementById('marketStatus');
  const timeEl = document.getElementById('marketTime');
  
  if (marketOpen) {
    statusEl.innerHTML = '<span style="background: rgba(0,245,160,0.2); color: #00f5a0; padding: 4px 10px; border-radius: 4px;">OPEN</span>';
  } else {
    statusEl.innerHTML = '<span style="background: rgba(255,61,113,0.2); color: #ff3d71; padding: 4px 10px; border-radius: 4px;">CLOSED</span>';
  }
  
  timeEl.textContent = new Date().toLocaleString();
}

// Search
document.getElementById('searchBox').addEventListener('input', function(e) {
  filterStocks();
});

// Filter
document.getElementById('filterSelect').addEventListener('change', function() {
  filterStocks();
});

function filterStocks() {
  const searchTerm = document.getElementById('searchBox').value.toLowerCase();
  const filterValue = document.getElementById('filterSelect').value;
  
  filteredStocks = allStocks.filter(stock => {
    // Search filter
    const matchesSearch = searchTerm === '' || 
      stock.symbol?.toLowerCase().includes(searchTerm) || 
      (stock.name && stock.name.toLowerCase().includes(searchTerm));
    
    // Action filter
    const matchesAction = filterValue === 'all' || stock.action === filterValue;
    
    return matchesSearch && matchesAction;
  });
  
  currentPage = 1;
  renderTable();
  updateCounts();
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  const start = (currentPage - 1) * pageSize;
  const pageStocks = filteredStocks.slice(start, start + pageSize);
  const marketOpen = isMarketOpen();
  const marketStatus = marketOpen ? 'OPEN' : 'CLOSED';
  const statusClass = marketOpen ? 'status-open' : 'status-closed';
  
  tbody.innerHTML = pageStocks.map((stock, i) => {
    const change = stock.daily_percentage || 0;
    const changeClass = change >= 0 ? 'positive' : 'negative';
    const changeSymbol = change >= 0 ? '▲' : '▼';
    
    let signalClass = '';
    if (stock.action === 'BUY') signalClass = 'signal-buy';
    else if (stock.action === 'HOLD') signalClass = 'signal-hold';
    else if (stock.action === 'SELL') signalClass = 'signal-sell';
    
    // Get trend short form
    let trendShort = '--';
    if (stock.trend_type) {
      if (stock.trend_type.includes('Strong Up')) trendShort = '↑↑';
      else if (stock.trend_type.includes('Up')) trendShort = '↑';
      else if (stock.trend_type.includes('Strong Down')) trendShort = '↓↓';
      else if (stock.trend_type.includes('Down')) trendShort = '↓';
      else trendShort = '→';
    }
    
    return `
      <tr class="table-row" onclick="window.location.href='/stock/${stock.symbol}'">
        <td>${start + i + 1}</td>
        <td><strong>${stock.symbol || '--'}</strong><br><small style="color: #8ba0b8;">${stock.name || ''}</small></td>
        <td>$${(stock.price || 0).toFixed(2)}</td>
        <td class="${changeClass}">${changeSymbol} ${Math.abs(change).toFixed(2)}%</td>
        <td>${stock.rsi || '--'}</td>
        <td style="font-size: 1.2rem;">${trendShort}</td>
        <td style="color: ${stock.score >= 70 ? '#00f5a0' : stock.score >= 40 ? '#ffaa00' : '#ff3d71'}; font-weight: bold;">${stock.score || '--'}</td>
        <td><span class="signal-badge ${signalClass}">${stock.action || '--'}</span></td>
        <td><span class="status-badge ${statusClass}">${marketStatus}</span></td>
      </tr>
    `;
  }).join('');
  
  updatePagination();
}

function updatePagination() {
  const totalPages = Math.ceil(filteredStocks.length / pageSize);
  const pagination = document.getElementById('pagination');
  
  let html = '';
  
  // Previous
  html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">←</button>`;
  
  // Page numbers
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);
  
  if (startPage > 1) {
    html += `<button class="page-btn" onclick="changePage(1)">1</button>`;
    if (startPage > 2) html += `<span style="color: #4a6080; padding: 0 5px;">...</span>`;
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += `<span style="color: #4a6080; padding: 0 5px;">...</span>`;
    html += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
  }
  
  // Next
  html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">→</button>`;
  
  pagination.innerHTML = html;
}

function changePage(page) {
  currentPage = page;
  renderTable();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateCounts() {
  document.getElementById('displayCount').textContent = filteredStocks.length;
  document.getElementById('totalCount').textContent = `Top ${allStocks.length} companies`;
}

async function loadAllStocks() {
  try {
    const res = await fetch('/api/stocks/all');
    const data = await res.json();
    
    allStocks = data.stocks || [];
    filteredStocks = [...allStocks];
    
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('tableView').style.display = 'block';
    
    renderTable();
    updateCounts();
    updateMarketStatus();
    
    // Update market status every minute
    setInterval(updateMarketStatus, 60000);
    
  } catch(e) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
  }
}

loadAllStocks();
</script>
{% endblock %}