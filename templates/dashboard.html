{% extends "base.html" %}

{% block title %}qweretjr Markets - Dashboard{% endblock %}

{% block content %}
<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <div>
    <h2 style="margin: 0;">TOP 10 STOCKS</h2>
    <small style="color: #8ba0b8;">Highest scored companies</small>
  </div>
  <div id="lastUpdated" style="background: #1a2535; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem;">
    Loading...
  </div>
</div>

<!-- Loading -->
<div id="loadingState" style="text-align: center; padding: 50px;">
  <div style="border: 3px solid #1a2535; border-top-color: #00f5a0; width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite;"></div>
  <p>Loading top stocks...</p>
</div>

<!-- Error -->
<div id="errorState" style="text-align: center; padding: 50px; color: #ff3d71; display: none;">
  Failed to load data
</div>

<!-- Top 10 Cards Grid -->
<div id="cardsGrid" style="display: none; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;"></div>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .stock-card {
    background: #0f1622;
    border: 1px solid #1a2535;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .stock-card:hover {
    border-color: #00f5a0;
    transform: translateY(-2px);
  }
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .card-symbol {
    font-size: 1.3rem;
    font-weight: bold;
  }
  
  .card-medal {
    font-size: 1.5rem;
    line-height: 1;
  }
  
  .card-rank {
    background: #1a2535;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
  }
  
  .card-price-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #1a2535;
  }
  
  .card-price {
    font-size: 1.8rem;
    font-weight: bold;
    font-family: monospace;
  }
  
  .card-change {
    font-size: 1rem;
    padding: 4px 8px;
    border-radius: 4px;
  }
  
  .positive {
    color: #00f5a0;
  }
  
  .negative {
    color: #ff3d71;
  }
  
  .card-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .stat {
    text-align: center;
  }
  
  .stat-label {
    font-size: 0.7rem;
    color: #8ba0b8;
    display: block;
    margin-bottom: 4px;
  }
  
  .stat-value {
    font-size: 1rem;
    font-weight: bold;
  }
  
  .card-trend {
    text-align: center;
    font-size: 0.9rem;
    padding: 8px;
    background: #1a2535;
    border-radius: 4px;
    margin-top: 10px;
  }
  
  .card-score {
    margin-top: 10px;
    text-align: right;
    font-weight: bold;
    font-size: 1.1rem;
  }
  
  .trend-up { color: #00f5a0; }
  .trend-down { color: #ff3d71; }
  .trend-neutral { color: #ffaa00; }
  
  /* Medal special borders */
  .stock-card.gold {
    border-left: 4px solid gold;
  }
  .stock-card.silver {
    border-left: 4px solid silver;
  }
  .stock-card.bronze {
    border-left: 4px solid #cd7f32;
  }
</style>

<script>
const loadingState = document.getElementById('loadingState');
const errorState = document.getElementById('errorState');
const cardsGrid = document.getElementById('cardsGrid');

function getMedal(index) {
  const medals = ['ðŸ¥‡ GOLD', 'ðŸ¥ˆ SILVER', 'ðŸ¥‰ BRONZE', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ðŸ”Ÿ'];
  return medals[index];
}

function getMedalClass(index) {
  if (index === 0) return 'gold';
  if (index === 1) return 'silver';
  if (index === 2) return 'bronze';
  return '';
}

function getTrendSymbol(trend) {
  if (!trend) return 'â†’';
  if (trend.includes('Strong Up')) return 'ðŸš€';
  if (trend.includes('Up')) return 'â–²';
  if (trend.includes('Strong Down')) return 'ðŸ’¥';
  if (trend.includes('Down')) return 'â–¼';
  return 'â†’';
}

function getTrendClass(trend) {
  if (!trend) return 'trend-neutral';
  if (trend.includes('Up')) return 'trend-up';
  if (trend.includes('Down')) return 'trend-down';
  return 'trend-neutral';
}

function getScoreColor(score) {
  if (score >= 70) return '#00f5a0';
  if (score >= 40) return '#ffaa00';
  return '#ff3d71';
}

async function loadDashboard() {
  try {
    const res = await fetch('/api/stocks/top');
    const data = await res.json();
    
    if (!data.stocks || data.stocks.length === 0) {
      throw new Error('No data');
    }
    
    // Get top 10 stocks
    const stocks = data.stocks.slice(0, 10);
    
    // Hide loading, show grid
    loadingState.style.display = 'none';
    cardsGrid.style.display = 'grid';
    
    // Render cards
    cardsGrid.innerHTML = stocks.map((stock, index) => {
      const isUp = stock.daily_percentage >= 0;
      const changeClass = isUp ? 'positive' : 'negative';
      const changeSymbol = isUp ? 'â–²' : 'â–¼';
      const trendSymbol = getTrendSymbol(stock.trend_type);
      const trendClass = getTrendClass(stock.trend_type);
      const scoreColor = getScoreColor(stock.score);
      const medal = getMedal(index);
      const medalClass = getMedalClass(index);
      
      return `
        <div class="stock-card ${medalClass}" onclick="window.location.href='/stock/${stock.symbol}'">
          <div class="card-header">
            <span class="card-symbol">${stock.symbol}</span>
            <span class="card-medal">${medal}</span>
          </div>
          
          <div class="card-price-row">
            <span class="card-price">$${(stock.price || 0).toFixed(2)}</span>
            <span class="card-change ${changeClass}">${changeSymbol} ${Math.abs(stock.daily_percentage || 0).toFixed(2)}%</span>
          </div>
          
          <div class="card-stats">
            <div class="stat">
              <span class="stat-label">RSI</span>
              <span class="stat-value ${stock.rsi < 30 ? 'positive' : stock.rsi > 70 ? 'negative' : ''}">${stock.rsi || '--'}</span>
            </div>
            <div class="stat">
              <span class="stat-label">PRICE</span>
              <span class="stat-value">$${(stock.price || 0).toFixed(2)}</span>
            </div>
            <div class="stat">
              <span class="stat-label">DAY %</span>
              <span class="stat-value ${changeClass}">${stock.daily_percentage ? stock.daily_percentage.toFixed(1) + '%' : '--'}</span>
            </div>
          </div>
          
          <div class="card-trend ${trendClass}">
            <strong>${trendSymbol} ${stock.trend_type || 'Neutral'}</strong>
          </div>
          
          <div class="card-score" style="color: ${scoreColor}">
            SCORE: ${stock.score || '--'}/100
          </div>
        </div>
      `;
    }).join('');
    
    // Update time
    document.getElementById('lastUpdated').innerHTML = `
      <span>${new Date().toLocaleTimeString()}</span>
    `;
    
  } catch(e) {
    loadingState.style.display = 'none';
    errorState.style.display = 'block';
    console.error('Dashboard error:', e);
  }
}

loadDashboard();
</script>
{% endblock %}